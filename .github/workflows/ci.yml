name: VPN Infrastructure CI

on:
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'          # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      - 'docs/**'        # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ø–∫—É docs
      - '.gitignore'     # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–∏—Ç–∞
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: '0 3 * * *'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 –ø–æ UTC (07:00 –ø–æ –ï—Ä–µ–≤–∞–Ω—É)

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install allure-pytest

    - name: Create .env file from Secrets
      run: |
        echo "TG_BOT_TOKEN=${{ secrets.TG_BOT_TOKEN }}" >> .env
        echo "TG_CHAT_ID=${{ secrets.TG_CHAT_ID }}" >> .env
        # Server_1
        echo "NODE_1_NAME=NL-AMS" >> .env
        echo "NODE_1_IP=${{ secrets.NODE_1_IP }}" >> .env
        echo "NODE_1_USER=${{ secrets.NODE_1_USER }}" >> .env
        echo "NODE_1_PASS=${{ secrets.NODE_1_PASS }}" >> .env
        echo "NODE_1_BACKUP_PATHS=/etc/x-ui,/opt/outline/persisted-state" >> .env
        # Server_2
        echo "NODE_2_NAME=AT-VIE" >> .env
        echo "NODE_2_IP=${{ secrets.NODE_2_IP }}" >> .env
        echo "NODE_2_USER=${{ secrets.NODE_2_USER }}" >> .env
        echo "NODE_2_PASS=${{ secrets.NODE_2_PASS }}" >> .env
        echo "NODE_2_BACKUP_PATHS=/etc/x-ui" >> .env      
        # Server_3
        echo "NODE_3_NAME=RU-MOW" >> .env
        echo "NODE_3_IP=${{ secrets.NODE_3_IP }}" >> .env
        echo "NODE_3_USER=${{ secrets.NODE_3_USER }}" >> .env
        echo "NODE_3_PASS=${{ secrets.NODE_3_PASS }}" >> .env
        echo "NODE_3_BACKUP_PATHS=/etc/x-ui" >> .env    
        # Server_4
        echo "NODE_4_NAME=DE-DUS" >> .env
        echo "NODE_4_IP=${{ secrets.NODE_4_IP }}" >> .env
        echo "NODE_4_USER=${{ secrets.NODE_4_USER }}" >> .env
        echo "NODE_4_PASS=${{ secrets.NODE_4_PASS }}" >> .env
        echo "NODE_4_BACKUP_PATHS=/var/lib/docker/volumes/remnawave_remnawave-db-data/_data" >> .env
        # Server_5
        # echo "NODE_5_NAME=NAME_your_server" >> .env
        # echo "NODE_5_IP=${{ secrets.NODE_5_IP }}" >> .env
        # echo "NODE_5_USER=${{ secrets.NODE_5_USER }}" >> .env
        # echo "NODE_5_PASS=${{ secrets.NODE_5_PASS }}" >> .env
        # echo "NODE_5_BACKUP_PATHS=BACKUP_PATHS_your server" >> .env

    - name: Run Tests with Allure
      run: |
        sudo -E $(which python) -m pytest -v --alluredir=allure-results

    - name: DevSecOps Fallback - Clean JSON artifacts
      if: always()
      run: |
        sudo apt-get update && sudo apt-get install -y jq
        find allure-results -name "*-result.json" -exec bash -c '
          jq "if .parameters then .parameters |= map(if (.name | ascii_downcase | test(\"password|pass|passw|secret|token|key|ip|user\")) then .value = \"'\"'***'\"'\" else . end) else . end" {} > {}.tmp && mv {}.tmp {}
          ' \;

    - name: Generate Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: allure-results
        allure_report: allure-report
        gh_pages: gh-pages
        allure_history: allure-history

    - name: Publish Report to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: allure-history

    - name: Send Telegram Alert on Failure
      if: failure()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
        -d chat_id=${{ secrets.TG_CHAT_ID }} \
        -d text="üö® –í–ù–ò–ú–ê–ù–ò–ï! –¢–µ—Å—Ç—ã VPN-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –£–ü–ê–õ–ò. –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–∏–ª–∏—Å—å! –°–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç: https://Andrei-Shishkov-QA.github.io/vpn-infrastructure-qa-suite/"